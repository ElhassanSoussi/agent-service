# Agent Service Deployment Workflow
# Deploys to production server on tag push
# Includes backup, healthcheck, and automatic rollback

name: Deploy

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.2.3, etc.)
  
  workflow_dispatch:  # Allow manual trigger
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.0.0)'
        required: false
        default: ''

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/agent-service' }}

jobs:
  # =============================================================================
  # Test job - runs before deployment
  # =============================================================================
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run linter
        run: ruff check .
        continue-on-error: true
      
      - name: Run tests
        env:
          AGENT_API_KEY: test-api-key
          AGENT_ADMIN_KEY: test-admin-key
          AGENT_KEY_HASH_SECRET: test-hash-secret
        run: pytest tests/ -v --tb=short

  # =============================================================================
  # Deploy job - deploys to production server
  # =============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: test  # Only deploy if tests pass
    
    # Only run on tags or manual dispatch
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Determine tag to deploy
        id: get_tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=" >> $GITHUB_OUTPUT
          fi
      
      - name: Display deployment info
        run: |
          echo "üöÄ Deploying Agent Service"
          echo "Tag: ${{ steps.get_tag.outputs.tag || 'latest' }}"
          echo "Server: ${{ secrets.SSH_HOST }}"
          echo "Path: ${{ env.DEPLOY_PATH }}"
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            
            echo "üìÅ Changing to deploy directory..."
            cd ${{ env.DEPLOY_PATH }}
            
            echo "üîÑ Running deployment script..."
            ./scripts/deploy.sh "${{ steps.get_tag.outputs.tag }}"
            
            echo "‚úÖ Deployment script completed"
      
      - name: Verify deployment (external health check)
        if: ${{ secrets.HEALTH_CHECK_URL != '' }}
        run: |
          echo "üè• Verifying deployment health..."
          
          # Wait for service to stabilize
          sleep 5
          
          # Check health endpoint
          for i in {1..10}; do
            if curl -fsS "${{ secrets.HEALTH_CHECK_URL }}" | grep -q '"status".*"ok"'; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "Attempt $i/10 failed, retrying..."
            sleep 3
          done
          
          echo "‚ùå Health check failed after 10 attempts"
          exit 1
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | ${{ steps.get_tag.outputs.tag || 'latest' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | ${{ github.workflow }} |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Notify job - sends notification on failure
  # =============================================================================
  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Notify deployment failure
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the workflow logs for details."
          # Add webhook/email notification here if needed
